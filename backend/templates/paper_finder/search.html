{% extends "paper_finder/base.html" %}
{% block title %}å‘èµ·æ£€ç´¢{% endblock %}
{% block content %}

<div class="card">
  <div class="card-header">å‘èµ·æ£€ç´¢ / æ‰¹é‡å¯¼å…¥</div>
  <div class="card-body">

    {# å…¨å±€è¡¨å•é”™è¯¯ #}
    {% if form.non_field_errors %}
      <div class="alert alert-danger">
        {% for e in form.non_field_errors %}<div>{{ e }}</div>{% endfor %}
      </div>
    {% endif %}

    <form method="post" enctype="multipart/form-data" class="row g-3" id="search-form">
      {% csrf_token %}

      <!-- å•äººæ£€ç´¢ï¼ˆä¸æ‰¹é‡å¯¼å…¥äºŒé€‰ä¸€ï¼‰ -->
      <h5 class="mt-2">å•äººæ£€ç´¢</h5>
      <div class="col-md-6">
        <label class="form-label">{{ form.name.label }}</label>
        {{ form.name }}
        {% if form.name.errors %}<div class="invalid-feedback d-block">{{ form.name.errors.0 }}</div>{% endif %}
      </div>
      <div class="col-md-6">
        <label class="form-label">{{ form.pinyin.label }}</label>
        {{ form.pinyin }}
        {% if form.pinyin.errors %}<div class="invalid-feedback d-block">{{ form.pinyin.errors.0 }}</div>{% endif %}
        <div class="form-text">{{ form.pinyin.help_text }}</div>
      </div>

      <div class="col-md-3">
        <label class="form-label">{{ form.start_date.label }}</label>
        {{ form.start_date }}
        {% if form.start_date.errors %}<div class="invalid-feedback d-block">{{ form.start_date.errors.0 }}</div>{% endif %}
      </div>
      <div class="col-md-3">
        <label class="form-label">{{ form.end_date.label }}</label>
        {{ form.end_date }}
        {% if form.end_date.errors %}<div class="invalid-feedback d-block">{{ form.end_date.errors.0 }}</div>{% endif %}
      </div>

      <div class="col-md-6">
        <label class="form-label">{{ form.affiliation.label }}</label>
        {{ form.affiliation }}
        {% if form.affiliation.errors %}<div class="invalid-feedback d-block">{{ form.affiliation.errors.0 }}</div>{% endif %}
        <div class="form-text">{{ form.affiliation.help_text }}</div>
      </div>

      <div class="col-md-12">
        <label class="form-label">{{ form.sources.label }}</label>
        <div class="d-flex flex-wrap gap-3">
          {{ form.sources }}
        </div>
        {% if form.sources.errors %}<div class="invalid-feedback d-block">{{ form.sources.errors.0 }}</div>{% endif %}

        <div class="mt-2">
          <a class="btn btn-outline-primary btn-sm" href="{% url 'paper_finder:paper_list' %}">
            ğŸ“„ æŸ¥çœ‹ç»“æœåˆ—è¡¨
          </a>
        </div>
      </div>

      <div class="col-md-12 form-check">
        {{ form.run_sync }} <label class="form-check-label">{{ form.run_sync.label }}</label>
        {% if form.run_sync.errors %}<div class="invalid-feedback d-block">{{ form.run_sync.errors.0 }}</div>{% endif %}
      </div>

      <div class="col-md-12 d-flex gap-2">
        <button class="btn btn-primary" type="submit" name="action" value="search">å¼€å§‹æ£€ç´¢</button>
        <button class="btn btn-outline-secondary" type="submit" name="action" value="preview">é¢„è§ˆå§“åå˜ä½“</button>
      </div>

      {# é¢„è§ˆåŒºï¼šç”±è§†å›¾åœ¨ action=preview è¿”å› #}
      {% if variant_groups %}
        <div class="col-12">
          <hr class="mt-2">
          <h5>ç”Ÿæˆçš„å§“åå˜ä½“ï¼ˆ{{ variant_count }} ä¸ªï¼‰</h5>
          <div class="text-muted small mb-2">P0=æ ¸å¿ƒï¼ŒP1=å¸¸ç”¨ï¼ŒP2=æ‰©å±•ï¼ŒP3=ä½ä¼˜å…ˆ</div>

          {% for prio, items in variant_groups %}
            {% if items %}
              <div class="mb-2">
                <div class="fw-bold mb-1">P{{ prio }}</div>
                <div class="d-flex flex-wrap gap-2">
                  {% for v in items %}
                    <span class="badge text-bg-light border px-2 py-2">{{ v }}</span>
                  {% endfor %}
                </div>
              </div>
            {% endif %}
          {% endfor %}
        </div>
      {% endif %}

      <hr class="my-4">

      <!-- æ‰¹é‡å¯¼å…¥ï¼ˆä¸å•äººæ£€ç´¢äºŒé€‰ä¸€ï¼‰ -->
      <h5>æ‰¹é‡å¯¼å…¥</h5>

      <div class="col-12">
        <label class="form-label">æ‰¹é‡å§“åï¼ˆæ¯è¡Œä¸€ä¸ªï¼Œé€—å·åˆ†éš”ï¼šå§“å[, æ‹¼éŸ³][, å•ä½]ï¼‰</label>
        {{ form.names_text }}
        {% if form.names_text.errors %}<div class="invalid-feedback d-block">{{ form.names_text.errors.0 }}</div>{% endif %}
        <div class="form-text">ç¤ºä¾‹ï¼šå¼ ä¸‰, zhang san, åŒ—äº¬é‚®ç”µå¤§å­¦ï¼›æ¯è¡Œä¸€æ¡ï¼Œæ‹¼éŸ³ä¸å•ä½å¯çœç•¥ã€‚</div>
      </div>

      <div class="col-12">
        <label class="form-label">æˆ–ä¸Šä¼  CSV/Excel</label>
        {{ form.names_file }}
        {% if form.names_file.errors %}<div class="invalid-feedback d-block">{{ form.names_file.errors.0 }}</div>{% endif %}
        <div class="form-text">åˆ—åï¼šname, pinyin, affiliation, start_date, end_dateï¼›æ”¯æŒ .csv / .xlsx</div>
      </div>

      <div class="col-md-4">
        <label class="form-label">é»˜è®¤å•ä½å…³é”®è¯ï¼ˆæ‰¹é‡ï¼‰</label>
        {{ form.default_affiliation }}
      </div>
      <div class="col-md-4">
        <label class="form-label">é»˜è®¤èµ·å§‹æ—¥æœŸï¼ˆæ‰¹é‡ï¼‰</label>
        {{ form.default_start_date }}
      </div>
      <div class="col-md-4">
        <label class="form-label">é»˜è®¤æˆªæ­¢æ—¥æœŸï¼ˆæ‰¹é‡ï¼‰</label>
        {{ form.default_end_date }}
      </div>

      <div class="col-12 d-flex gap-2">
        <button class="btn btn-primary" type="submit" name="action" value="search">å¼€å§‹å¯¼å…¥</button>
        <a class="btn btn-outline-secondary" href="{% url 'paper_finder:job_history' %}">æŸ¥çœ‹å†å²ä»»åŠ¡</a>
      </div>
    </form>
  </div>
</div>

{% endblock %}
